syntax = "proto3";

package tailor.v1;

import "buf/validate/validate.proto";
import "google/api/field_behavior.proto";
import "tailor/v1/resource.proto";

message IdPService {
  Namespace namespace = 1;
  string authorization = 2;
  string provider_url = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
  IdPUserAuthPolicy user_auth_policy = 4;
  // lang is the IETF BCP 47 language subtag.
  IdPLang lang = 5;
  // publish_user_events indicates whether user lifecycle events (created, updated, deleted) are enabled.
  // When enabled, events are published to the dataplane event topic.
  bool publish_user_events = 6;
}

// IdPLang represents the IETF BCP 47 language subtag.
enum IdPLang {
  ID_P_LANG_UNSPECIFIED = 0;
  ID_P_LANG_EN = 1;
  ID_P_LANG_JA = 2;
}

message IdPClient {
  string name = 1;
  string client_id = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  string client_secret = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message IdPUserAuthPolicy {
  option (buf.validate.message).cel = {
    id: "password_length_consistency"
    message: "password_min_length must be less than or equal to password_max_length"
    // Always validate using effective values (use default 6 for min, 4096 for max if unset)
    expression: "(this.password_min_length == 0 ? 6 : this.password_min_length) <= (this.password_max_length == 0 ? 4096 : this.password_max_length)"
  };
  option (buf.validate.message).cel = {
    id: "allowed_email_domains_requires_email_identifier"
    message: "allowed_email_domains cannot be set when use_non_email_identifier is true"
    expression: "this.allowed_email_domains.size() == 0 || !this.use_non_email_identifier"
  };
  option (buf.validate.message).cel = {
    id: "allow_google_oauth_requires_email_identifier"
    message: "allow_google_oauth cannot be enabled when use_non_email_identifier is true"
    expression: "!this.allow_google_oauth || !this.use_non_email_identifier"
  };
  option (buf.validate.message).cel = {
    id: "allow_google_oauth_requires_allowed_email_domains"
    message: "allowed_email_domains must be set when allow_google_oauth is true"
    expression: "!this.allow_google_oauth || this.allowed_email_domains.size() > 0"
  };
  option (buf.validate.message).cel = {
    id: "disable_password_auth_requires_google_oauth"
    message: "disable_password_auth requires allow_google_oauth to be enabled"
    expression: "!this.disable_password_auth || this.allow_google_oauth"
  };
  option (buf.validate.message).cel = {
    id: "disable_password_auth_conflicts_with_self_password_reset"
    message: "allow_self_password_reset cannot be enabled when disable_password_auth is true"
    expression: "!this.disable_password_auth || !this.allow_self_password_reset"
  };

  bool use_non_email_identifier = 1;
  bool allow_self_password_reset = 2;
  // Password policy fields (stored in Identity Platform, not in DB)
  bool password_require_uppercase = 3;
  bool password_require_lowercase = 4;
  bool password_require_non_alphanumeric = 5;
  bool password_require_numeric = 6;
  // password_min_length: valid range is 6-30 (default: 6). When 0 (unset), uses default value 6.
  int32 password_min_length = 7 [(buf.validate.field).cel = {
    id: "password_min_length_range"
    message: "password_min_length must be 0 (default) or between 6 and 30"
    expression: "this == 0 || (this >= 6 && this <= 30)"
  }];
  // password_max_length: valid range is 6-4096 (default: 4096). When 0 (unset), uses default value 4096.
  int32 password_max_length = 8 [(buf.validate.field).cel = {
    id: "password_max_length_range"
    message: "password_max_length must be 0 (default) or between 6 and 4096"
    expression: "this == 0 || (this >= 6 && this <= 4096)"
  }];
  // List of allowed email domains (e.g., ["example.com", "corp.example.com"])
  // Empty list means all domains are allowed (backward compatible)
  // Cannot be set when use_non_email_identifier is true
  repeated string allowed_email_domains = 9 [(buf.validate.field).repeated = {
    unique: true
    max_items: 100
    items: {
      string: {hostname: true}
    }
  }];
  // allow_google_oauth enables "Sign in with Google" for this namespace.
  // When enabled, users can authenticate using their Google account.
  // Cannot be enabled when use_non_email_identifier is true.
  // Requires allowed_email_domains to be set.
  bool allow_google_oauth = 10;
  // disable_password_auth disables password-based authentication for this namespace.
  // When enabled, users cannot sign in or reset their password using email/password.
  // Requires allow_google_oauth to be enabled.
  // Cannot be used with allow_self_password_reset.
  bool disable_password_auth = 11;
}
